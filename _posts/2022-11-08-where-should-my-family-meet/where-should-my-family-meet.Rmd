---
title: "Where should my family meet?"
description: |
  A short description of the post.
author:
  - name: Etienne Bacher
    url: {}
date: 2022-11-08
draft: true
output:
  distill::distill_article
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

I have several brothers, and we are quite split in the world. I'm currently in Luxembourg, two of them are in France but in different locations, one is in Asia, and the last one is in South America.

I was thinking: in which place should we meet if we wanted to minimize the total distance, i.e the sum of the distances made by each one? I'm just thinking in terms of distance as the crow flies, because of course the distance also depends on where we must go to take the plane, on the potential flight change we have to make, etc.

This question is used in a lot of optimal location problems. For example, where should a factory be built so that it minimizes the sum of distances to a list of warehouses? However, I didn't know about it before thinking about my original question, and it's not as simple as it looked like to me. I thought a bit more about that, searched online, asked to other members of my family more comfortable with maths, and this blog post summarizes what I learnt from that. 

As every other post on this blog, it will include some R code, but that will come later.

## The problem in 2D

The question I want to answer is: where should I meet with my brothers to minimize the total distance? Something that is not clearly mentioned here is that I want to minimize the total distance **on a sphere** (because, surprise, the Earth is close to a sphere). This adds a layer of complexity, so let's start first with a 2D analysis.

Suppose I have 5 points placed on a grid with an x-axis and a y-axis, such as below:

<center>
```{tikz, echo=FALSE, fig.ext = 'png'}
\usetikzlibrary{decorations.pathreplacing,angles,quotes}
\colorlet{DarkGreen}{green!40!black!60}
\colorlet{LightBlue}{blue!60!white!40}
\colorlet{LightRed}{red!40!white!60}
\colorlet{DarkRed}{red!40!black!60}
\begin{tikzpicture}[scale=1.3]
  \draw[step=1cm,gray,very thin] (-3,-2) grid (5,5);
  \draw [<-] (0,5) -- (0,-2);
  \draw [->] (-3,0) -- (5,0);
  \draw[fill] (1,0) circle [radius=0.05];
  \node [red, below] at (1,0) {$(1,0)$};
  \draw[fill] (2,1) circle [radius=0.05];
  \node [red, below] at (2,1) {$(2,1)$};
  \draw[fill] (-3,0) circle [radius=0.05];
  \node [red, left] at (-3,0) {$(-3,0)$};
  \draw[fill] (-2,2) circle [radius=0.05];
  \node [red, above] at (-2,2) {$(-2,2)$};
  \draw[fill] (0,3) circle [radius=0.05];
  \node [red, left] at (0,3) {$(0,3)$};
\end{tikzpicture}
```
</center>

I want to find the point $(X,Y)$ that minimizes the sum of distances from each point to $(X,Y)$. Here, I use the [Euclidean distance](https://en.wikipedia.org/wiki/Euclidean_distance), but other measures are possible (such as the [Manhattan distance](https://en.wikipedia.org/wiki/Taxicab_geometry)). The formula for the Euclidean distance between two points $(x_1, y_1)$ and $(x_2, y_2)$ is:

$$dist = \sqrt{(x_1-x_2)^2 + (y_1-y_2)^2}$$

For example, the distance between the points $(1,0)$ and $(2,1)$ is^[To be sure, we know that the distance between those two points is the diagonal of a square with sides of length 1, and that the length of the diagonal of a square with sides of length $a$ is $a\sqrt{2}$.]:

$$
\begin{aligned}
dist = & \sqrt{(1-2)^2 + (0-1)^2}\\
= & \sqrt{1+1} \\
= & \sqrt{2}
\end{aligned}
$$

Here, I want to find the point $(X,Y)$ that minimizes:

$$Total \ distance = D = \sum_{i=1}^5\sqrt{(x_i-X)^2 + (y_i-Y)^2}$$

The point $(X,Y)$ that solves this is called the [geometric median](https://en.wikipedia.org/wiki/Geometric_median), or $L_1$-median. If we only had two points, then any point on the segment between those two points would be a solution^[For example, if the two points are separated by 1000 km, then putting the meeting point at 200 km from one and 800 km from the other would give the same total distance as putting the meeting point at 500 km far from each point.]. But here, we have five points.

However, according to Wikipedia^[Consulted on December 29, 2021.],

> Despite the geometric median's being an easy-to-understand concept, computing it poses a challenge. [...] Therefore, only numerical or symbolic approximations to the solution of this problem are possible under this model of computation.

In other words, while it is theoretically possible to compute the exact solution to this problem, it is impossible to do so in reasonable time in practice when the number of points is very large (note that there are some special cases, such as $n=3$ or $n=4$). This is why we need to use an approximation algorithm. One algorithm commonly used for that is the Weiszfeld's algorithm. This algorithm works iteratively. The steps are the following:

* pick a random point $P_0 = (X_0, Y_0)$
* compute $X_1 = \frac{\sum_{i=1}^5 \frac{x_i}{\sqrt{(x_i-X_0)^2 + (y_i-Y_0)^2}}}{\sum_{i=1}^5 \frac{1}{\sqrt{(x_i-X_0)^2 + (y_i-Y_0)^2}}}$ and $Y_1 = \frac{\sum_{i=1}^5 \frac{x_i}{\sqrt{(x_i-X_0)^2 + (y_i-Y_0)^2}}}{\sum_{i=1}^5 \frac{1}{\sqrt{(x_i-X_0)^2 + (y_i-Y_0)^2}}}$
* compute the distance $\varepsilon$ between $(X_0, Y_0)$ and $(X_1, Y_1)$
* repeat steps 2 and 3 until $\varepsilon$ is lower than an arbitrary threshold. This will give an approximate solution $(X, Y)$.

<br>

<details> 

<summary>If you are interested in how we obtain the formula in the bullet points above, click here.</summary>

<br>
We differentiate with respect to $X$:

$$
\begin{aligned}
\frac{\partial D}{\partial X} & = 0 \\
\sum_{i=1}^5\frac{\partial \sqrt{(x_i-X)^2 + (y_i-Y)^2}}{\partial X} & = 0 \\
\sum_{i=1}^5 -\frac{- 2x_i + 2X}{2\sqrt{(x_i-X)^2 + (y_i-Y)^2}} & = 0 \\
\sum_{i=1}^5 \frac{x_i - X}{\sqrt{(x_i-X)^2 + (y_i-Y)^2}} & = 0 \\
\sum_{i=1}^5 \frac{x_i}{\sqrt{(x_i-X)^2 + (y_i-Y)^2}} - \sum_{i=1}^5 \frac{X}{\sqrt{(x_i-X)^2 + (y_i-Y)^2}} & = 0 \\
\sum_{i=1}^5 \frac{x_i}{\sqrt{(x_i-X)^2 + (y_i-Y)^2}} - X \sum_{i=1}^5 \frac{1}{\sqrt{(x_i-X)^2 + (y_i-Y)^2}} & = 0 \\
X = & \ \frac{\sum_{i=1}^5 \frac{x_i}{\sqrt{(x_i-X)^2 + (y_i-Y)^2}}}{\sum_{i=1}^5 \frac{1}{\sqrt{(x_i-X)^2 + (y_i-Y)^2}}} \\
X^* = & \ T(X^*) \\
\end{aligned}
$$

Similarly,

$$
\begin{align}
Y^* = & \ \frac{\sum_{i=1}^5 \frac{x_i}{\sqrt{(x_i-X)^2 + (y_i-Y^*)^2}}}{\sum_{i=1}^5 \frac{1}{\sqrt{(x_i-X)^2 + (y_i-Y^*)^2}}} \\
Y^* = & \ T(Y^*) \\
\end{align}
$$

Now, we can make a loop like the following:

* start with $X = X_0$ and $Y = Y_0$, and compute $X_1 = T(X_0)$ and $Y_1 = T(Y_0)$
* compute $X_2 = T(X_1)$ and $Y_2 = T(Y_1)$
* continue until the distance between $(X_n, X_{n+1})$ and $(Y_n, Y_{n+1})$ is smaller than an arbitrary $\varepsilon$. 

Once again, I'm not mathematician, so this may seem not rigorous at all for someone with more experience. If you're interested in a rigorous explanation of Weiszfeld's algorithm, check out [this paper](https://ssabach.net.technion.ac.il/files/2015/12/BS2015.pdf) (but there are many others online).
</details>

<br>

As usual with R, when you think of a widely used algorithm or feature, there's necessarily an R package for that. Here, I will use the package `Gmedian` and the function `Weiszfeld()`:

```{r}
library(Gmedian)
```

This function has 4 arguments:

* `X` is a matrix of points, where each row is an observation;
* `weights` is useful if we want to give more importance to some points. Here, we assume that all 4 points are equally important, so we set it to `NULL` (the default);
* `epsilon` is the threshold below which the algorithm will stop;
* `nitermax` is the maximum number of iterations that will be run. This is complementary to `epsilon`: the algorithm stops as soon as the difference between two $(X, Y)$ is lower than `epsilon` or as the algorithm hits the maximum number of iterations.

We can keep the defaults for `epsilon` and `nitermax`, so we just need to create a matrix containing our four points, and run this in `Weiszfeld()`:

```{r}
# Create matrix
my_points <- rbind(c(1, 0), c(2, 1), c(-3, 0), c(0, 3), c(-2,2))
my_points

median_point <- Weiszfeld(my_points)
median_point
```

This returns the geometric median and the number of iterations that was necessary to reach it. In the example above, the optimal point is therefore at (`r round(median_point$median[1], 2)`, `r round(median_point$median[2], 2)`):

```{tikz, echo=FALSE, fig.ext = 'png'}
\usetikzlibrary{decorations.pathreplacing,angles,quotes}
\colorlet{DarkGreen}{green!40!black!60}
\colorlet{LightBlue}{blue!60!white!40}
\colorlet{LightRed}{red!40!white!60}
\colorlet{DarkRed}{red!40!black!60}
\begin{tikzpicture}[scale=1.3]
  \draw[step=1cm,gray,very thin] (-3,-2) grid (5,5);
  \draw [<-] (0,5) -- (0,-2);
  \draw [->] (-3,0) -- (5,0);
  \draw[fill] (1,0) circle [radius=0.05];
  \node [red, below] at (1,0) {$(1,0)$};
  \draw[fill] (2,1) circle [radius=0.05];
  \node [red, below] at (2,1) {$(2,1)$};
  \draw[fill] (-3,0) circle [radius=0.05];
  \node [red, left] at (-3,0) {$(-3,0)$};
  \draw[fill] (-2,2) circle [radius=0.05];
  \node [red, above] at (-2,2) {$(-2,2)$};
  \draw[fill] (0,3) circle [radius=0.05];
  \node [red, left] at (0,3) {$(0,3)$};
  \draw[fill] (-0.27,1.36) circle [radius=0.05];
  \node [blue, left] at (-0.27,1.36) {$(-0.27,1.36)$};
\end{tikzpicture}
```

We can now compute the sum of distances between each original point and the geometric median:

```{r}
list_dist <- c()
for (i in 1:nrow(my_points)) {
  foo <- my_points[i, ]
  list_dist[i] <- dist(rbind(foo, median_point$median))
}
sum(list_dist)
```

Bottom line, when we study this problem in 2D, we can use Weiszfeld's algorithm. The problem is slightly more complicated when we look at distances on a sphere.


## Distance between two points on the edge of a circle

```{tikz, echo=FALSE, fig.ext = 'png'}
\usetikzlibrary{shapes}
\begin{tikzpicture}[scale = 1.3]
\draw[step=1cm,white,very thin] (-2,-2) grid (2,2);
\draw (0,0) circle (1cm);
\end{tikzpicture}
```






## The problem in 3D 

<!-- Now that we know how to solve this question in 2D, we need to add a third dimension because we are looking for distance minimization on a sphere. Although the formulas will change a bit, the underlying rationale is similar. -->

<!-- Before looking for the point that minimizes the sum of distances, we first need to know how to compute a distance between a pair of latitude and longitude on a sphere. -->


```{r}
library(echarts4r)
library(echarts4r.assets)
coords <- data.frame(
  lat = c(49.497509, 48.390392, 45.194260, 4.938000, 17.975706),
  long = c(5.982500, -4.486076, 5.731670, -52.335049, 102.633102)
)
coords |> 
  e_charts() |> 
  e_globe(
    base_texture = ea_asset("world bw"), 
    displacementScale = 0.05,
    viewControl = list(autoRotate = FALSE)
  ) |> 
  e_scatter_3d(
    long, lat,
    coord_system = "globe"
  ) |> 
  e_legend(FALSE)
```

